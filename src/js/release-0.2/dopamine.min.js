this.dopamine=this.dopamine||{};
dopamine.utils=function(a){a.isoTime=function(){return JSON.parse(JSON.stringify(new Date))};a.isoDate=function(a){a||(a=new Date);var b=a.getFullYear()+"",c=a.getMonth()+1+"";a=a.getDate()+"";1===c.length&&(c="0"+c);1===a.length&&(a="0"+a);return b+"-"+c+"-"+a};a.getNewId=function(){var a="";if(window.crypto&&window.crypto.getRandomValues){var b=new Uint32Array(8);window.crypto.getRandomValues(b);for(var c=0;c<b.length;c++)a+=b[c].toString(16)}else for(b=0;36>b;b++)a+="0123456789abcdef".substr(Math.floor(16*
Math.random()),1);return a};a.getUrlParam=function(a,b){b||(b=window.location.search.substring(1));for(var c=b.split("&"),g=0;g<c.length;g++)if(c[g].split("=")[0]===a)return decodeURIComponent(c[g].split("=")[1]);return null};a.addShortcut=function(a,b,c){if(!dopamine.getAdrenaline()||!dopamine.getAdrenaline().addShortCut)return!1;"https://"===b.substring(0,8)&&(b="adrenalines://"+b.substring(8));"http://"===b.substring(0,7)&&(b="adrenaline://"+b.substring(7));dopamine.getAdrenaline().addShortCut(a,
b,c);return!0};a.isAdrenalineAndroid=function(){return"undefined"!==typeof window._cordovaExec};a.isAdrenalineIos=function(a,b){a||(a=navigator.platform);b||(b=navigator.userAgent);for(var c=["iPad","iPhone","iPod","iPhone Simulator","iPad Simulator"],g=0;g<c.length;g++)if(a===c[g])return 0<=b.indexOf("Adrenaline");return!1};return a}(dopamine.utils||{},jQuery);this.dopamine=this.dopamine||{};
dopamine.appendStore=function(a,e){a.BASE_URL="http://release-0-2.adrenalinemobility.appspot.com/objstore/append";a.append=function(b,g,h,f,k,j,d,n){b={key:b,values:JSON.stringify(g)};k&&(b.actionUrl=k,b.title=j,b.message=d,n&&(b.myPushUrl=n));e.ajax({url:a.BASE_URL+"/append",type:"POST",data:b,dataType:"json",success:h,error:f})};a.get=function(b,g,h,f){g||(g=0);e.ajax({url:a.BASE_URL+"/get",type:"POST",data:{key:b,start_index:g},dataType:"json",success:h,error:f})};a.addPushUrl=function(c,g,e,f){b(a.BASE_URL+
"/add_push_url",c,g,e,f)};a.removePushUrl=function(c,g,e,f){b(a.BASE_URL+"/rem_push_url",c,g,e,f)};var b=function(a,b,h,f,k){e.ajax({url:a,type:"POST",data:{key:b,push_url:h},dataType:"json",success:f,error:k})};return a}(dopamine.appendStore||{},jQuery);
this.dopamine=(this.dopamine=function(a){a.getAdrenaline=function(){return"undefined"!==typeof window.adrenaline?window.adrenaline:null};a.__commandQueue=[];var e=Math.floor(2E9*Math.random()),b={},c;a.__callbackSuccess=function(a,e){if(b[a]){if(1===e.status)try{b[a].success&&b[a].success(e.message)}catch(c){console.log("Error in success callback: "+a+" = "+c)}e.keepCallback||delete b[a]}};a.__callbackError=function(a,e){if(b[a]){try{b[a].fail&&b[a].fail(e.message)}catch(c){console.log("Error in success callback: "+
a+" = "+c)}e.keepCallback||delete b[a]}};a._getExecIframe=function(){if(c)return c;c=document.createElement("IFRAME");c.style.display="none";document.body.appendChild(c);return c};a.exec=function(c,h,f,k,j){if(a.utils.isAdrenalineIos())try{var d=f+e++,n=JSON.stringify(j);if(c||h)b[d]={success:c,fail:h};a.__commandQueue.push(JSON.stringify([d,f,k,n]));a._getExecIframe().src="adrenaline://ready"}catch(l){console.log("iOSExec error: "+l)}else try{var s=f+e++,p=JSON.stringify(j);if(c||h)b[s]={success:c,
fail:h};window._cordovaExec.exec(f,k,e,p)}catch(q){console.log("dopamine.exec error: "+q)}};return a}(this.dopamine||{},jQuery))||{};
dopamine.objStore=function(a,e){function b(){var d;var c=k();d=0===c.length?null:c.shift();var f;null===d?r=!1:(r=!0,d.value=JSON.stringify(d.value),e.ajax({url:a.OBJSTORE_POST_URL,type:"POST",data:d,dataType:"json",success:function(c){if("ok"===c["return"]){if(c.key===d.key&&(f=k(),f.shift(),j(f)),null!==a.onobjectposted)a.onobjectposted(c.key,!1,!1)}else if(f=k(),f.shift(),j(f),r=!1,null!==a.onobjectposted)a.onobjectposted(c.key,!0,!0);b()},error:function(){r=!1;if(null!==a.onobjectposted)a.onobjectposted(d.key,
!0,!1)}}))}function c(){r||b()}function g(a){"undefined"===typeof a&&(a=f());return a}function h(a,d){d=g(d);return d+"-"+a}function f(){if(null!=m)return m;m=localStorage.getItem(l);null==m&&(m=dopamine.utils.getNewId(),localStorage.setItem(l,m));return m}function k(){var a=localStorage.getItem(n);return null===a?[]:JSON.parse(a)}function j(a){localStorage.setItem(n,JSON.stringify(a))}function d(){var a=localStorage.getItem(s);a=Number(a)||0;if(a!==p){if(a>p)throw console.log("ERROR: Object store newer than this copy of dopamine. Not proceeding."),
dopamine.objStore=null,"This version of the Object Store is incompatible with the data stored locally. Try a newer version.";localStorage.setItem(s,p)}}var n=".adrenaline.objstore.serverQueue",l=".adrenaline.objstore.deviceid",s=".adrenaline.objstore.metadata.version",p=1;a.OBJSTORE_POST_URL="http://release-0-2.adrenalinemobility.appspot.com/objstore/set_item";var q=!1,m=null,r=!1;a.onobjectposted=null;a._setDeviceId=function(a){m=null!=a?a:null};a.getDefaultUuid=f;a._getDeviceId=f;a._flush=c;a.setItem=
function(a,d,b){var e=h(a,b);b=g(b);localStorage.setItem(e,JSON.stringify(d));a={key:a,value:d,uuid:b};d=k();b=!1;2<=d.length&&(e=d.length-1,d[e].key===a.key&&d[e].uuid===a.uuid&&(d[e].value=a.value,b=!0));b||d.push(a);j(d);q&&c()};a.getItem=function(a,d){var b=h(a,d),b=localStorage.getItem(b);return null==b?null:JSON.parse(b)};a.removeItem=function(a,d){var b=h(a,d);localStorage.removeItem(b)};a.disableFlushOnWrite=function(){q=!1};a.enableFlushOnWrite=function(){q=!0;c()};a.hasPendingData=function(){return 0<
a.pendingDataCount()};a.pendingDataCount=function(){return k().length};dopamine._initCallbacks=dopamine._initCallbacks||e.Callbacks();dopamine._initCallbacks.add(d);d();return a}(dopamine.objStore||{},jQuery);this.dopamine=this.dopamine||{};
dopamine.plugins=function(a){a.requestFullscreen=function(a){var b={toast:!0,button:!0};"undefined"!==typeof a&&(b.toast=a);dopamine.exec(null,null,"FullScreenPlugin","requestFullscreen",[b])};a.cancelFullscreen=function(){dopamine.exec(null,null,"FullScreenPlugin","cancelFullscreen",[])};return a}(dopamine.plugins||{},jQuery);this.dopamine=this.dopamine||{};
dopamine.updateStream=function(a,e){a.UPDATESTREAM_URL="http://release-0-2.adrenalinemobility.appspot.com/updatestream";a.INTERNAL_API="1";var b=function(b,j,d){return e.ajax({url:a.UPDATESTREAM_URL+"/channelComms",type:"POST",data:{data:JSON.stringify({api:a.INTERNAL_API,tokenValue:b,type:j,mData:d})}})},c=function(){console.log("channel connected");this.connected=!0;this.onConnect.fire();this.onConnect=e.Callbacks();b(this.token,"connected",this.index)},g=function(a){var b,d={};try{b=JSON.parse(a.data),
d.data=JSON.parse(b.data),d.type=b.type,d.index=b.index}catch(c){console.log("failed to decode message: "+c);return}if(d.index!==this.index)console.log("Message received out of order! OH SNAP"),console.log("received: "+d.index+" instead of "+this.index),console.log(d),this.receiveBuffer[d.index]=d;else{console.log("Message received in order.");console.log("received: "+d.index+" (which is) "+this.index);for(h.call(this,d);this.index in this.receiveBuffer;)d=this.receiveBuffer[this.index],delete this.receiveBuffer[this.index],
h.call(this,d)}},h=function(a){console.log("Handling message with index: "+a.index);var b=0,d;for(d in this.receiveBuffer)isNaN(d)||b++;console.log("buffer size: "+b);this.index++;"type"in a&&void 0!==a.type?"error"===a.type?(console.log(this.name+": Error message received: "),console.error(a.data)):"rollup"===a.type&&this.fullCB?this.fullCB(!0,!0,a.data):"normal"===a.type&&this.updateCB&&this.updateCB(!1,!0,a.data):console.log(this.name+": bad message received"+a)},f=function(a){this.token=a.tokenValue;
this.fullCB=this.updateCB=null;this.isSubscribed=!1;this.canWrite=a.canWrite||!1;this.name="Unnamed UpdateStream";this.index=0;this.receiveBuffer=[]};f.prototype.setName=function(a){this.name=a};f.prototype.getMyToken=function(){return this.token};f.prototype.createNewToken=function(b){var c=e.Deferred();b=b||{};e.ajax({url:a.UPDATESTREAM_URL+"/createNewToken",type:"POST",data:{data:JSON.stringify({api:a.INTERNAL_API,tokenValue:this.token,canWrite:b.canWrite||!1,canDelegate:b.canDelegate||!1})}}).done(function(a){a&&
"ok"===a["return"]?c.resolveWith(this,[a.data.tokenValue]):c.rejectWith(this,[a])}).fail(function(a){c.rejectWith(this,[a])});return c};f.prototype.subscribe=function(b,j){var d=e.Deferred(),f=e.Deferred(),l=this;if(this.isSubscribed)return console.log(this.name+": re-subscribing to a UpdateStream is not allowed"),d.rejectWith(this,["err_resubscribe","re-subscribing is not allowed"]),d.promise();console.log(this.name+": called subscribe. 'this' is set to: ");console.log(this);this.isSubscribed=!0;
null!=b&&(this.updateCB=b);null!=j&&(this.fullCB=j);e.ajax({url:a.UPDATESTREAM_URL+"/subscribe",type:"POST",data:{data:JSON.stringify({api:a.INTERNAL_API,tokenValue:this.token})}}).done(function(a){a&&"ok"===a["return"]?f.resolveWith(this,[a.data]):f.rejectWith(this,[a])}).fail(function(a){f.rejectWith(this,[a])});e.when(f).done(function(a){l.channelToken=a.channelToken;a=new goog.appengine.Channel(l.channelToken);l.onConnect=e.Callbacks();l.onConnect.add(d.resolve);console.log("opening channel");
a=a.open({onopen:e.proxy(c,l),onmessage:e.proxy(g,l)});a.onerror=function(){console.log("channel error")};a.onclose=function(){l.connected=!1;console.log(l.name+": onClose, unexpected")};console.log("Channel token: "+l.channelToken);l.socket=a}).fail(function(a){console.log("subscribe failed");console.log(a);d.rejectWith(this,["subscribe failed",a])});return d.promise()};f.prototype.unsubscribe=function(){var a=e.Deferred(),b=this;console.log("unsub");this.isSubscribed?(console.log(this.name+": unsubscribed"),
this.socket.onclose=function(){console.log(b.name+": closed");b.connected=!1;b.isSubscribed=!1;a.resolve()},this.socket.close()):(a.reject(),console.log(this.name+": unsubscribed when not subscribed"));return a.promise()};f.prototype.sendUpdate=function(a){var c=e.Deferred();if(!this.isSubscribed)return c.rejectWith(this,["err_not_subscribed","Stream not subscribed"]),c.promise();if(!this.canWrite)return c.rejectWith(this,["err_illegal","This token is not allowed to write"]),c.promise();b(this.token,
"update",JSON.stringify(a)).done(function(a){a&&"ok"===a["return"]?c.resolve():c.reject(a)}).fail(function(){c.reject("Failed to send update message")});return c.promise()};a.createUpdateStream=function(a){return new f(a)};a.createNew=function(){var b=e.Deferred();e.ajax({url:a.UPDATESTREAM_URL+"/createNew",type:"POST",data:{data:JSON.stringify({api:a.INTERNAL_API})}}).done(function(c){c&&"ok"===c["return"]?b.resolveWith(this,[a.createUpdateStream(c.data)]):b.rejectWith(this,[c])}).fail(b.reject);
return b.promise()};a.retrieveFromToken=function(b){var c=e.Deferred();e.ajax({url:a.UPDATESTREAM_URL+"/retrieveToken",type:"POST",data:{data:JSON.stringify({api:a.INTERNAL_API,token:b})}}).done(function(b){b&&"ok"===b["return"]?c.resolveWith(this,[a.createUpdateStream(b.data)]):c.rejectWith(this,[b])}).fail(function(a){c.rejectWith(this,[a])});return c};return a}(dopamine.updateStream||{},jQuery);this.dopamine=this.dopamine||{};
dopamine.webPush=function(a){function e(a){for(var b;0<j.length;)b=j.shift(),localStorage.setItem(h,a),b(a)}function b(a){var b=localStorage.getItem(h);if(b)setTimeout(function(){e(b)},0);else{var j=d.checkPermission();j===g?a&&d.requestPermission(f):j===c&&d.requestPushUrl(k)}}var c=0,g=1,h=".adrenaline.webpush.pushurl",f="dopamine.webPush._requestPermissionCb",k="dopamine.webPush._requestPushUrlCb",j,d;a._reset=function(){localStorage.removeItem(h);d="undefined"!==typeof window.webPush?window.webPush:
null;j=[]};a._reset();a.requestPushUrl=function(c){if(a.hasPush())if(dopamine.utils.isAdrenalineIos()){var e=localStorage.getItem(h);e?setTimeout(function(){c(e)},0):dopamine.exec(function(a){localStorage.setItem(h,a);c(a)},null,"WebPush","requestPushUrl",[])}else null!==d&&(b(!0),j.push(c))};a.hasPush=function(){return null!==d||dopamine.utils.isAdrenalineIos()};a._requestPermissionCb=function(){b(!1)};a._requestPushUrlCb=function(a){e(a)};return a}(dopamine.webPush||{},jQuery);

